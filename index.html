<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Funnel Plots for Comparing Institutional Performance • FunnelPlotR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="48x48" href="favicon-48x48.png">
<link rel="icon" type="”image/svg+xml”" href="favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" sizes="any" href="favicon.ico">
<link rel="manifest" href="site.webmanifest">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Funnel Plots for Comparing Institutional Performance">
<meta property="og:description" content="An implementation of methods presented by Spiegelhalter (2005) &lt;doi:10.1002/sim.1970&gt; Funnel plots for comparing institutional performance, for standardised ratios, ratios of counts and proportions with additive overdispersion adjustment.">
<meta property="og:image" content="https://nhs-r-community.github.io/FunnelPlotR/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-146859070-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-146859070-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">FunnelPlotR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.6.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="articles/funnel_plots.html">Introduction to Funnel Plots</a>
    </li>
    <li>
      <a href="articles/changing_funnel_plot_options.html">Changing funnel plot options</a>
    </li>
  </ul>
</li>
<li>
  <a href="news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/nhs-r-community/FunnelPlotR" class="external-link">
    <span class="fa fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="contents col-md-9">
<div class="section level1">
<div class="page-header"><h1 id="funnel-plots-for-comparing-institutional-performance-">Funnel Plots for Comparing Institutional Performance <img src="reference/figures/logo.png" width="160px" align="right"><a class="anchor" aria-label="anchor" href="#funnel-plots-for-comparing-institutional-performance-"></a>
</h1></div>
<!-- badges: start -->

<div class="section level2">
<h2 id="funnel-plots">Funnel Plots<a class="anchor" aria-label="anchor" href="#funnel-plots"></a>
</h2>
<p>This is an implementation of the funnel plot processes, and overdispersion methods described in:<br><a href="https://doi.org/10.1111/j.1467-985X.2011.01010.x" class="external-link">Statistical methods for healthcare regulation: rating, screening and surveillance. Spiegelhalter et al (2012)</a><br><a href="https://doi.org/10.1002/sim.1970" class="external-link">Funnel plots for comparing institutional performance. Spiegelhalter (2005)</a><br><a href="https://dx.doi.org/10.1136/qshc.2005.013755" class="external-link">Handling over-dispersion of performance indicators. Spiegelhalter (2005)</a><br></p>
<p>It draws funnel plots using <code>ggplot2</code> and allows users to specify whether they want to adjust the funnel plot limits for ‘overdispersion.’ This adjustment makes the assumption that we are dealing with clusters of values (means) at institutions that are themselves arranged around a global mean. We then have ‘within’ institution variation and ‘between institution’ variation. The process assessed the expected variance in our data, and where it is greater than that expected by the Poisson distribution, uses the difference as a scaling factor. It is then used in an additive fashion, after an adjustment for outliers by either Winsorised or truncated (with a default 10% at each end of the distribution.)</p>
<p>Methods are based on those presented in Spiegelhalter’s papers and the Care Quality Commission’s Intelligent Monitoring methodology documents, with methods for proportions, ratios of counts and indirectly standardised ratios. There is a also a variant method for standardised ratios, used in the NHS’ Summary Hospital Mortality Indicator’<br><a href="https://digital.nhs.uk/data-and-information/publications/ci-hub/summary-hospital-level-mortality-indicator-shmi/" class="external-link">Summary Hospital-level Mortality Indicator, NHS Digital, SHMI specification</a> <br></p>
<p>This variant uses a log-transformation and truncation of the distribution for calculating overdispersion, whereas Spiegelhalter’s methods use a square-root and Winsorisation.</p>
<p>Contributions are welcome. Please note that the ‘FunnelPlotR’ project is released with a <a href="https://nhs-r-community.github.io/FunnelPlotR/CODE_OF_CONDUCT.html">Contributor Code of Conduct</a>. By contributing to this project, you agree to abide by its terms.</p>
<p>More information available at <a href="https://nhs-r-community.github.io/FunnelPlotR/" class="uri">https://nhs-r-community.github.io/FunnelPlotR/</a></p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>You can install from CRAN:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"FunnelPlotR"</span><span class="op">)</span></span></code></pre></div>
<p>You can install the development version directly from GitHub using the <code>remotes</code> (or <code>devtools</code>) package. Please be aware that, although I endeavour have help files up-to-date, this version may different from the one on CRAN. Please consult the help documentation if you get error messages.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"https://github.com/nhs-r-community/FunnelPlotR"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="summary-of-use">Summary of Use<a class="anchor" aria-label="anchor" href="#summary-of-use"></a>
</h2>
<p>We will load the <code>medpar</code> dataset from Hilbe’s <code>COUNT</code> package. This is based on 1991 Medicare files for the state of Arizona <em>(Hilbe, Joseph M (2014), Modeling Count Data, Cambridge University Press)</em>. We will first load the data and build a simple predictive model using a Poisson GLM.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nhs-r-community.github.io/FunnelPlotR/">FunnelPlotR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">COUNT</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># lets use the 'medpar' dataset from the 'COUNT' package. Little reformatting needed</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">medpar</span><span class="op">)</span></span>
<span><span class="va">medpar</span><span class="op">$</span><span class="va">provnum</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">medpar</span><span class="op">$</span><span class="va">provnum</span><span class="op">)</span></span>
<span><span class="va">medpar</span><span class="op">$</span><span class="va">los</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">medpar</span><span class="op">$</span><span class="va">los</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">los</span> <span class="op">~</span> <span class="va">hmo</span> <span class="op">+</span> <span class="va">died</span> <span class="op">+</span> <span class="va">age80</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">type</span><span class="op">)</span>, family<span class="op">=</span><span class="st">"poisson"</span>, data<span class="op">=</span><span class="va">medpar</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; glm(formula = los ~ hmo + died + age80 + factor(type), family = "poisson", </span></span>
<span><span class="co">#&gt;     data = medpar)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;               Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span><span class="co">#&gt; (Intercept)    2.26875    0.01246 182.011  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; hmo           -0.07637    0.02393  -3.192  0.00142 ** </span></span>
<span><span class="co">#&gt; died          -0.24574    0.01826 -13.458  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; age80         -0.02141    0.02050  -1.045  0.29617    </span></span>
<span><span class="co">#&gt; factor(type)2  0.24921    0.02099  11.871  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; factor(type)3  0.74869    0.02627  28.496  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; (Dispersion parameter for poisson family taken to be 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Null deviance: 8901.1  on 1494  degrees of freedom</span></span>
<span><span class="co">#&gt; Residual deviance: 7977.7  on 1489  degrees of freedom</span></span>
<span><span class="co">#&gt; AIC: 13705</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Number of Fisher Scoring iterations: 5</span></span></code></pre></div>
<p>Now we have a regression that we can use to get a predicted <code>los</code> that we will compare to observed <code>los</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">medpar</span><span class="op">$</span><span class="va">prds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod</span>, type<span class="op">=</span><span class="st">"response"</span><span class="op">)</span></span></code></pre></div>
<p><br><br> We can build a funnel plot object with standard Poisson limits, and outliers labelled.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/funnel_plot.html">funnel_plot</a></span><span class="op">(</span><span class="va">medpar</span>, numerator <span class="op">=</span> <span class="va">los</span>, denominator <span class="op">=</span> <span class="va">prds</span>, group <span class="op">=</span> <span class="va">provnum</span>, </span>
<span>            title <span class="op">=</span> <span class="st">'Length of Stay Funnel plot for `medpar` data'</span>, data_type <span class="op">=</span> <span class="st">"SR"</span>, limit<span class="op">=</span>  <span class="fl">99</span>,</span>
<span>            draw_unadjusted <span class="op">=</span> <span class="cn">TRUE</span>, draw_adjusted <span class="op">=</span> <span class="cn">FALSE</span>, label <span class="op">=</span> <span class="st">"outlier"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-funnel1-1.png" width="100%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co">#&gt; A funnel plot object with 54 points of which 25 are outliers. </span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="co">#&gt; Plot is not adjusted for overdispersion.</span></span></code></pre></div>
<p><br><br></p>
<p>That looks like too many outliers! There is more variation in our data than we would expect, and this is referred to as: <strong>overdispersion</strong>. So lets check for it: <br> The following ratio should be 1 if our data are conforming to Poisson distribution assumption (conditional mean = variance). If it is greater than 1, we have overdispersion:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">mod</span><span class="op">$</span><span class="va">weights</span> <span class="op">*</span> <span class="va">mod</span><span class="op">$</span><span class="va">residuals</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">mod</span><span class="op">$</span><span class="va">df.residual</span></span>
<span><span class="co">#&gt; [1] 6.240519</span></span></code></pre></div>
<p>This suggest the variance is 6.24 times the condition mean, and definitely overdispersed. This is a huge topic, but applying overdispersed limits using either SHMI or Spiegelhalter methods adjust for this by inflating the limits:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/funnel_plot.html">funnel_plot</a></span><span class="op">(</span><span class="va">medpar</span>, numerator <span class="op">=</span> <span class="va">los</span>, denominator <span class="op">=</span> <span class="va">prds</span>, group <span class="op">=</span> <span class="va">provnum</span>, data_type <span class="op">=</span> <span class="st">"SR"</span>,</span>
<span>            title <span class="op">=</span> <span class="st">'Length of Stay Funnel plot for `medpar` data'</span>, draw_unadjusted <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>            draw_adjusted <span class="op">=</span> <span class="cn">TRUE</span>, sr_method <span class="op">=</span> <span class="st">"SHMI"</span>, label <span class="op">=</span> <span class="st">"outlier"</span>, limit <span class="op">=</span> <span class="fl">99</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-funnel2-1.png" width="100%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co">#&gt; A funnel plot object with 54 points of which 9 are outliers. </span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="co">#&gt; Plot is adjusted for overdispersion.</span></span></code></pre></div>
<p><br><br> These methods can be used for any similar indicators, e.g. standardised mortality ratios, readmissions etc.</p>
<p>Please read the package documentation for more info, at: <a href="https://nhs-r-community.github.io/FunnelPlotR/" class="uri">https://nhs-r-community.github.io/FunnelPlotR/</a></p>
<p>Funnel Plot HEX sticker/logo by Paul Chipperfield</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://cloud.r-project.org/package=FunnelPlotR" class="external-link">View on CRAN</a></li>
<li><a href="https://github.com/nhs-r-community/FunnelPlotR/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/nhs-r-community/FunnelPlotR/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>

<div class="community">
<h2 data-toc-skip>Community</h2>
<ul class="list-unstyled">
<li><a href="CODE_OF_CONDUCT.html">Code of conduct</a></li>
</ul>
</div>

<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing FunnelPlotR</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>
<a href="https://www.mainard.co.uk" class="external-link">Chris Mainey</a> <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0002-3018-6171" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
<li><a href="authors.html">More about authors...</a></li>
</ul>
</div>



  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://www.mainard.co.uk" class="external-link">Chris Mainey</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
