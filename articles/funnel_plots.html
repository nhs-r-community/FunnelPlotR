<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Funnel Plots for Indirectly-standardised ratios • FunnelPlotR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="48x48" href="../favicon-48x48.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Funnel Plots for Indirectly-standardised ratios">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-146859070-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-146859070-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">FunnelPlotR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/funnel_plots.html">Introduction to Funnel Plots</a>
    </li>
    <li>
      <a href="../articles/changing_funnel_plot_options.html">Changing funnel plot options</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/nhs-r-community/FunnelPlotR" class="external-link">
    <span class="fa fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Funnel Plots for Indirectly-standardised
ratios</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/nhs-r-community/FunnelPlotR/blob/main/vignettes/funnel_plots.Rmd" class="external-link"><code>vignettes/funnel_plots.Rmd</code></a></small>
      <div class="hidden name"><code>funnel_plots.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="funnel-plots">Funnel plots<a class="anchor" aria-label="anchor" href="#funnel-plots"></a>
</h2>
<p>Funnel plots are a common tool for comparing organisations or units
using proportions or standardised rates. A common use of them is for
monitoring mortality at hospitals. This is an introductory post on the
subject, that gives a little information about them and how they are
constructed. It is deliberately light on theory, focusing on use, some
of the theory is referenced for interested readers.</p>
<p>There are different kinds of funnel plot, for this vignette, we will
focuses on the type used to compare standardised mortality and other
similarly constructed indicators.</p>
</div>
<div class="section level2">
<h2 id="why-do-we-use-them">Why do we use them?<a class="anchor" aria-label="anchor" href="#why-do-we-use-them"></a>
</h2>
<div class="section level3">
<h3 id="rationale">Rationale<a class="anchor" aria-label="anchor" href="#rationale"></a>
</h3>
<p>How do you go about comparing organisations? We could simply look at
indicator data and rank them, but that could be unfair if the conditions
are different at each organisation. E.g. every hospital differs in size,
the services it offers, and the patients it sees. We might expect a
hospital seeing a higher proportion of elderly patients to have a higher
mortality rate. Is it fair to compare it to an organisation serving a
younger population who may be ‘healthier’ in general? Naively comparing
organisations by ranking in league tables has been shown to be a bad
idea <span class="citation">(Goldstein and Spiegelhalter, 1996; Lilford
<em>et al.</em>, 2004)</span>.</p>
<p>This scenario is not a million miles away from the techniques used in
meta-analysis of clinical trials, where we may have trials of different
sizes, with different estimates of effect, and differing variances. Some
of the techniques applied to meta-analysis have been adapted for
healthcare monitoring, including funnel plots and methods to adjust for
overdispersion <span class="citation">(Spiegelhalter, 2005a, 2005b;
Spiegelhalter <em>et al.</em>, 2012)</span>.</p>
</div>
<div class="section level3">
<h3 id="construction">Construction<a class="anchor" aria-label="anchor" href="#construction"></a>
</h3>
<p>If we want to compare a standardised ratio or similar indicator, we
can make a plot with the indicator on the Y-axis, and a measure of the
unit size on the X-axis. This is commonly the sum of the predicted
values for standardised ratios (e.g. the predicted number of cases), or
the number of patients/discharges etc. Our centre line, the average
value, can be surrounded by ‘control limits,’ a concept from Statistical
Process Control. These limits are statistical boundaries to separate
natural (‘common-cause’) variation and systematic differences
(‘special-cause variation’) <span class="citation">(Mohammed <em>et
al.</em>, 2001)</span>. This is commonly at organisational level, but
could be at any aggregation.</p>
<p>The reason these limits resemble a funnel is due to the effects of
size. The expected variation is larger when we are looking at fewer
cases. For example, imagine an experiment where we toss an unbiased coin
to see the expected value. If we toss that coin twice and both are
‘heads,’ our data is telling us that all coin tosses end up as ‘heads.’
This is not true, and we are making an assumption that we know would be
different if we repeated it more times. The margin of error around this
is high. So if we performed the same experiment 10, 100 or 1000 times,
we would expect it to become 50:50, heads/tails, and the margin of error
is proportionally smaller. This is also true of indicators based on
counts, like funnel plots. We expect less variation between points as
organisations get larger.</p>
</div>
<div class="section level3">
<h3 id="example">Example:<a class="anchor" aria-label="anchor" href="#example"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make up some data, as if it was from a regression model with observed and predicted (expected) events.</span></span>
<span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>observed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">15</span>,<span class="fl">40</span>,<span class="fl">72</span>,<span class="fl">28</span>,<span class="fl">50</span>, <span class="fl">66</span>, <span class="fl">75</span><span class="op">)</span>,</span>
<span>                 expected <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">13</span>,<span class="fl">32</span>,<span class="fl">75</span>,<span class="fl">33</span>,<span class="fl">54</span>, <span class="fl">60</span>, <span class="fl">72</span><span class="op">)</span>,</span>
<span>                 unit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>,<span class="st">"B"</span>,<span class="st">"c"</span>,<span class="st">"D"</span>,<span class="st">"E"</span>, <span class="st">"F"</span>, <span class="st">"G"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add a ratio (SR) of observed to expected, our indicator </span></span>
<span><span class="va">dt</span><span class="op">$</span><span class="va">SR</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">$</span><span class="va">observed</span> <span class="op">/</span> <span class="va">dt</span><span class="op">$</span><span class="va">expected</span></span>
<span></span>
<span><span class="co"># Scatter plot in ggplot</span></span>
<span><span class="va">a</span><span class="op">&lt;-</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dt</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">expected</span>, y<span class="op">=</span> <span class="va">SR</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">a</span></span></code></pre></div>
<p><img src="funnel_plots_files/figure-html/basicfunnel-1.png" width="672"></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Now add a central line, in a ration like this, 1 is the average/expected value.</span></span>
<span><span class="va">a</span><span class="op">&lt;-</span> <span class="va">a</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">a</span></span></code></pre></div>
<p><img src="funnel_plots_files/figure-html/basicfunnel-2.png" width="672"></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Add a 95% Poisson limit, by using the density function to get the quantile value for each 'expected'.</span></span>
<span><span class="va">lkup</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dt</span><span class="op">$</span><span class="va">expected</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lkup</span><span class="op">$</span><span class="va">Upper</span><span class="op">&lt;-</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">qpois</a></span><span class="op">(</span><span class="fl">0.975</span>,lambda <span class="op">=</span> <span class="va">lkup</span><span class="op">$</span><span class="va">id</span><span class="op">)</span> <span class="op">-</span> <span class="fl">0.025</span><span class="op">)</span> <span class="op">/</span> <span class="va">lkup</span><span class="op">$</span><span class="va">id</span></span>
<span><span class="va">lkup</span><span class="op">$</span><span class="va">lower</span><span class="op">&lt;-</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">qpois</a></span><span class="op">(</span><span class="fl">0.025</span>,lambda <span class="op">=</span> <span class="va">lkup</span><span class="op">$</span><span class="va">id</span><span class="op">)</span> <span class="op">-</span> <span class="fl">0.975</span><span class="op">)</span> <span class="op">/</span> <span class="va">lkup</span><span class="op">$</span><span class="va">id</span></span>
<span></span>
<span><span class="va">lkup</span><span class="op">&lt;-</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html" class="external-link">gather</a></span><span class="op">(</span><span class="va">lkup</span>, <span class="va">key</span>, <span class="va">value</span>,<span class="op">-</span><span class="va">id</span><span class="op">)</span></span>
<span></span>
<span><span class="va">a</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">id</span>, y<span class="op">=</span><span class="va">value</span>, col<span class="op">=</span><span class="va">key</span><span class="op">)</span>, data<span class="op">=</span><span class="va">lkup</span><span class="op">)</span></span></code></pre></div>
<p><img src="funnel_plots_files/figure-html/basicfunnel-3.png" width="672"></p>
<p>You’ll probably notice the ‘jagged’ lines in the plot above. This is
because the Poisson distribution is only defined on integers, and most
common implementations of Poisson functions make some sort of
rounding/guess between points. They are generally poorly defined on low
values, but there are other options that I’ll discuss in another future
post.</p>
<p><br></p>
</div>
</div>
<div class="section level2">
<h2 id="expanding-limits">Expanding limits<a class="anchor" aria-label="anchor" href="#expanding-limits"></a>
</h2>
<p>The methods described above have been developed into a basic R
package to draw these plots using <code>ggplot2</code>. It also allows
users to specify whether they want ‘overdispersed’ limits. I will write
another post about overdispersion in the coming weeks, but essentially,
we have more variation than we would expect from theory alone. To
account for this, we can estimate how much greater the variance in our
data is, and expand the funnel limits by this amount.</p>
<p>Part of this process involves ‘Winsorisation’ of the distribution
<span class="citation">(Spiegelhalter, 2005b; Spiegelhalter <em>et
al.</em>, 2012)</span>, where we set the outer most values to a defined
percentile to reduce the effects of outliers. This is commonly set to
10% at each end of the distribution, but there is a variant method for
this, used in the NHS’ Summary Hospital Mortality Indicator’, where the
distribution is truncated instead of Winsorised <span class="citation">(Clinical Indicators Team, 2018)</span>.</p>
<p>I originally wrote this package to present plots for my PhD thesis,
focused on predicting NRLS incident reporting ratios after
risk-adjustment. The overdispersion was particularly high in this case,
and differences between the two methods were noticeable, with the
SHMI/truncation method appearing better suited.</p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="application">Application<a class="anchor" aria-label="anchor" href="#application"></a>
</h2>
<p>Here we will apply this to some data by picking up the
<code>medpar</code> dataset discussed by Hilbe and available in the
<code>COUNT</code> package <span class="citation">(Hilbe, 2014)</span>.
It is a set of data points from hospitals in Arizona, in 1991, based on
US Medicare data. We’ll use the ‘length of stay’ field ’,
<code>los</code>, and model it from the other predictors in the
data.</p>
<div class="section level3">
<h3 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"https://github.com/nhs-r-community/FunnelPlotR"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="basic-model-build">Basic model build<a class="anchor" aria-label="anchor" href="#basic-model-build"></a>
</h3>
<p>We will first load the data and build a simple predictive model,
using a Poisson GLM, with a few of the predictors from the dataset. This
post is not focused on modelling techniques, but a Poisson Generalised
Linear Model (GLM) is more appropriate for count data than linear
regression. The key message, though, is that Poisson models make no
adjustment for the variance within the data and are likely to be
overdispersed. A more sophisticated approach might use something like a
negative binomial or multilevel model (discussed in a later post).</p>
<p>A little reformatting is required before modelling:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nhs-r-community.github.io/FunnelPlotR/">FunnelPlotR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">COUNT</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">medpar</span><span class="op">)</span></span>
<span><span class="va">medpar</span><span class="op">$</span><span class="va">provnum</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">medpar</span><span class="op">$</span><span class="va">provnum</span><span class="op">)</span></span>
<span><span class="va">medpar</span><span class="op">$</span><span class="va">los</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">medpar</span><span class="op">$</span><span class="va">los</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">los</span> <span class="op">~</span> <span class="va">hmo</span> <span class="op">+</span> <span class="va">died</span> <span class="op">+</span> <span class="va">age80</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">type</span><span class="op">)</span>, family<span class="op">=</span><span class="st">"poisson"</span>, data<span class="op">=</span><span class="va">medpar</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; glm(formula = los ~ hmo + died + age80 + factor(type), family = "poisson", </span></span>
<span><span class="co">#&gt;     data = medpar)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;               Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span><span class="co">#&gt; (Intercept)    2.26875    0.01246 182.011  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; hmo           -0.07637    0.02393  -3.192  0.00142 ** </span></span>
<span><span class="co">#&gt; died          -0.24574    0.01826 -13.458  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; age80         -0.02141    0.02050  -1.045  0.29617    </span></span>
<span><span class="co">#&gt; factor(type)2  0.24921    0.02099  11.871  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; factor(type)3  0.74869    0.02627  28.496  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; (Dispersion parameter for poisson family taken to be 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Null deviance: 8901.1  on 1494  degrees of freedom</span></span>
<span><span class="co">#&gt; Residual deviance: 7977.7  on 1489  degrees of freedom</span></span>
<span><span class="co">#&gt; AIC: 13705</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Number of Fisher Scoring iterations: 5</span></span></code></pre></div>
<p>Now we have a regression that we can use to get a predicted
<code>los</code> that we will compare to observed <code>los</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">medpar</span><span class="op">$</span><span class="va">prds</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod</span>, type<span class="op">=</span><span class="st">"response"</span><span class="op">)</span></span></code></pre></div>
<p><br></p>
</div>
<div class="section level3">
<h3 id="build-plot">Build plot<a class="anchor" aria-label="anchor" href="#build-plot"></a>
</h3>
<p>Now we can build a funnel plot object with standard Poisson limits,
and outliers labelled. The function returns an S3 object, with various
methods including <code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code>, <code>outlier()</code>,
<code><a href="../reference/limits.html">limits()</a></code>, <code><a href="../reference/source_data.html">source_data()</a></code> etc. See the help
file: <code><a href="../reference/funnel_plot.html">?funnel_plot</a></code> for more details.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="../reference/funnel_plot.html">funnel_plot</a></span><span class="op">(</span><span class="va">medpar</span>, numerator<span class="op">=</span><span class="va">los</span>, denominator<span class="op">=</span><span class="va">prds</span>, group <span class="op">=</span> <span class="va">provnum</span>, </span>
<span>            title <span class="op">=</span> <span class="st">'Length of Stay Funnel plot for `medpar` data'</span>, draw_unadjusted <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>            draw_adjusted <span class="op">=</span> <span class="cn">FALSE</span>,label <span class="op">=</span> <span class="st">"outlier"</span>, limit<span class="op">=</span><span class="fl">99</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: ggrepel: 5 unlabeled data points (too many overlaps). Consider</span></span>
<span><span class="co">#&gt; increasing max.overlaps</span></span></code></pre></div>
<p><img src="funnel_plots_files/figure-html/funnel1-1.png" width="672" style="display: block; margin: auto;"></p>
<pre><code><span><span class="co">#&gt; A funnel plot object with 54 points of which 25 are outliers. </span></span>
<span><span class="co">#&gt; Plot is not adjusted for overdispersion.</span></span></code></pre>
<p><br></p>
</div>
<div class="section level3">
<h3 id="overdispersion">Overdispersion<a class="anchor" aria-label="anchor" href="#overdispersion"></a>
</h3>
<p>That looks like too many outliers! There is more variation in our
data than we would expect, and this is referred to as:
<strong>overdispersion</strong>.</p>
<p><br> So lets check for it: <br> The following ratio should be 1 if
our data are conforming to Poisson distribution assumption (conditional
mean = variance). If it is greater than 1, we have overdispersion:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">mod</span><span class="op">$</span><span class="va">weights</span> <span class="op">*</span> <span class="va">mod</span><span class="op">$</span><span class="va">residuals</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">mod</span><span class="op">$</span><span class="va">df.residual</span></span>
<span><span class="co">#&gt; [1] 6.240519</span></span></code></pre></div>
<p>This suggests the variance is 6.24 times the condition mean, and
definitely overdispersed. This is a huge topic, but applying
overdispersed limits using either SHMI or Spiegelhalter methods adjust
for this by inflating the limits:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/funnel_plot.html">funnel_plot</a></span><span class="op">(</span><span class="va">medpar</span>, numerator<span class="op">=</span><span class="va">los</span>, denominator<span class="op">=</span><span class="va">prds</span>, group <span class="op">=</span> <span class="va">provnum</span>, </span>
<span>            title <span class="op">=</span> <span class="st">'Length of Stay Funnel plot for `medpar` data'</span>, draw_unadjusted <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>            draw_adjusted <span class="op">=</span> <span class="cn">TRUE</span>, data_type<span class="op">=</span><span class="st">"SR"</span>, sr_method <span class="op">=</span> <span class="st">"SHMI"</span>,label <span class="op">=</span> <span class="st">"outlier"</span>, limit<span class="op">=</span><span class="fl">99</span></span>
<span>            <span class="op">)</span></span></code></pre></div>
<p><img src="funnel_plots_files/figure-html/funnel2-1.png" width="672" style="display: block; margin: auto;"></p>
<pre><code><span><span class="co">#&gt; A funnel plot object with 54 points of which 9 are outliers. </span></span>
<span><span class="co">#&gt; Plot is adjusted for overdispersion.</span></span></code></pre>
<p><br><br> Given these adjustments, we now only have nine organisations
showing special-cause variation. To interpret this plot properly, we
would first investigate these outlying organisations before making any
changes to the system/indicator. We should check for possible data
quality issues, such as errors, missing model predictors, environmental
factors (e.g. one organisation changing computer systems and data
standards etc. during the monitoring period), but once these are
examined we might suspect issues with care at the hospitals in question.
They can then be investigated by local audit and casenote review.</p>
<p>These methods can be used for any similar indicators,
e.g. standardised mortality ratios, readmissions etc.</p>
<p><br></p>
</div>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>Funnel plots are useful ways to visualise indicators such as
mortality, readmission and length of stay data at hospitals, that
presents both the indicator value but also a measure of the
size/variance at organisations. They allow limits to be drawn between
what we might expect by chance, and what we might consider to be a
signal for investigation. Organisations outside the funnel limits should
be examined, first for data quality issues and then for issues with
process and clinical care. Overdispersion means that these limits are
often too strict, but they can be inflated to adjusted for this.</p>
<p><br></p>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body">
<div id="ref-clinicalindicatorsteamnhsdigitalSummaryHospitallevelMortality2018" class="csl-entry">
Clinical Indicators Team, N. D. (2018) <span>‘Summary
<span>Hospital</span>-level <span>Mortality Indicator</span>
(<span>SHMI</span>) - <span>Indicator</span> specification’</span>.
<span>NHS Digital</span>.
</div>
<div id="ref-goldsteinLeagueTablesTheir1996" class="csl-entry">
Goldstein, H. and Spiegelhalter, D. J. (1996) <span>‘League
<span>Tables</span> and <span>Their Limitations</span>:
<span>Statistical Issues</span> in <span>Comparisons</span> of
<span>Institutional Performance</span>’</span>, <em>Journal of the Royal
Statistical Society: Series A (Statistics in Society)</em>, 159(3), pp.
385–409. doi: <a href="https://doi.org/10.2307/2983325" class="external-link">10.2307/2983325</a>.
</div>
<div id="ref-hilbeModelingCountData2014" class="csl-entry">
Hilbe, J. M. (2014) <em>Modeling <span>Count Data</span></em>.
Cambridge: <span>Cambridge University Press</span>. doi: <a href="https://doi.org/10.1017/CBO9781139236065" class="external-link">10.1017/CBO9781139236065</a>.
</div>
<div id="ref-lilfordUseMisuseProcess2004" class="csl-entry">
Lilford, R. <em>et al.</em> (2004) <span>‘Use and misuse of process and
outcome data in managing performance of acute medical care: Avoiding
institutional stigma’</span>, <em>Lancet</em>, 363(9415), pp. 1147–54.
doi: <a href="https://doi.org/10.1016/s0140-6736(04)15901-1" class="external-link">10.1016/s0140-6736(04)15901-1</a>.
</div>
<div id="ref-mohammedBristolShipmanClinical2001" class="csl-entry">
Mohammed, M. A. <em>et al.</em> (2001) <span>‘Bristol,
<span>Shipman</span>, and clinical governance: <span>Shewhart</span>’s
forgotten lessons’</span>, <em>The Lancet</em>, 357(9254), pp. 463–467.
doi: <a href="https://doi.org/10.1016/S0140-6736(00)04019-8" class="external-link">10.1016/S0140-6736(00)04019-8</a>.
</div>
<div id="ref-spiegelhalterFunnelPlotsComparing2005" class="csl-entry">
Spiegelhalter, D. J. (2005a) <span>‘Funnel plots for comparing
institutional performance’</span>, <em>Stat Med</em>, 24(8), pp.
1185–202. doi: <a href="https://doi.org/10.1002/sim.1970" class="external-link">10.1002/sim.1970</a>.
</div>
<div id="ref-spiegelhalterHandlingOverdispersionPerformance2005" class="csl-entry">
Spiegelhalter, D. J. (2005b) <span>‘Handling over-dispersion of
performance indicators’</span>, <em>Quality and Safety in Health
Care</em>, 14(5), pp. 347–351. doi: <a href="https://doi.org/10.1136/qshc.2005.013755" class="external-link">10.1136/qshc.2005.013755</a>.
</div>
<div id="ref-spiegelhalterStatisticalMethodsHealthcare2012" class="csl-entry">
Spiegelhalter, D. J. <em>et al.</em> (2012) <span>‘Statistical methods
for healthcare regulation: Rating, screening and surveillance’</span>,
<em>Journal of the Royal Statistical Society: Series A (Statistics in
Society)</em>, 175(1), pp. 1–47. doi: <a href="https://doi.org/10.1111/j.1467-985X.2011.01010.x" class="external-link">10.1111/j.1467-985X.2011.01010.x</a>.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://www.mainard.co.uk" class="external-link">Chris Mainey</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
