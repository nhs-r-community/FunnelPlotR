<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Funnel Plots for Indirectly-standardised ratios • FunnelPlotR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Funnel Plots for Indirectly-standardised ratios">
<meta property="og:description" content="">
<meta property="og:image" content="https://chrismainey.github.io/FunnelPlotR/logo.png">
<meta name="twitter:card" content="summary">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-146859070-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-146859070-1');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">FunnelPlotR</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.2.2.999</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/funnel_plot.html">Introduction to Funnel Plots</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/chrismainey/FunnelPlotR">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Funnel Plots for Indirectly-standardised ratios</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/chrismainey/FunnelPlotR/blob/master/vignettes/funnel_plots.Rmd"><code>vignettes/funnel_plots.Rmd</code></a></small>
      <div class="hidden name"><code>funnel_plots.Rmd</code></div>

    </div>

    
    
<div id="funnel-plots" class="section level2">
<h2 class="hasAnchor">
<a href="#funnel-plots" class="anchor"></a>Funnel plots</h2>
<p>Funnel plots are a common tool for comparing organisations or units using proportions or standardised rates. A common use of them is for monitoring mortality at hospitals. This is an introductory post on the subject, that gives a little information about them and how they are constructed. It is deliberately light on theory, focusing on use, some of the theory is referenced for interested readers.</p>
<p>This post also uses a funnel plot function, for indirectly standardised ratios, that I built as part of my PhD work. The function is based on <code>ggplot2</code> <span class="citation">(Wickham 2009)</span>, and is available at <a href="https://github.com/chrismainey/FunnelPlotR" class="uri">https://github.com/chrismainey/FunnelPlotR</a>, although it’s a work in progress.</p>
<p>There are different kinds of funnel plot, but this post focuses on the type used to compare standardised mortality and other similarly constructed indicators .</p>
</div>
<div id="why-do-we-use-them" class="section level2">
<h2 class="hasAnchor">
<a href="#why-do-we-use-them" class="anchor"></a>Why do we use them?</h2>
<div id="rationale" class="section level3">
<h3 class="hasAnchor">
<a href="#rationale" class="anchor"></a>Rationale</h3>
<p>How do you go about comparing organisations? We could simply look at indicator data and rank them, but that could be unfair if the conditions are different at each organisation. E.g. every hospital differs in size, the services it offers, and the patients it sees. We might expect a hospital seeing a higher proportion of elderly patients to have a higher mortality rate. Is it fair to compare it to an organisation serving a younger population who may be ‘healthier’ in general? Naively comparing organisations by ranking in league tables has been shown to be a bad idea <span class="citation">(Goldstein and Spiegelhalter 1996; Lilford et al. 2004)</span>.</p>
<p>This scenario is not a million miles away from the techniques used in meta-analysis of clinical trial, where we may have trials of different sizes, with different estimates of effect, and differing variances. Some of the techniques applied to meta-analysis have been adapted for healthcare monitoring, including funnel plots and methods to adjust for overdispersion <span class="citation">(Spiegelhalter 2005a, 2005b; Spiegelhalter et al. 2012)</span>.</p>
</div>
<div id="construction" class="section level3">
<h3 class="hasAnchor">
<a href="#construction" class="anchor"></a>Construction</h3>
<p>If we want to compare a standardised ratio or similar indicator, we can make a plot with the indicator on the Y-axis, and a measure of the unit size on the X-axis. This is commonly the sum of the predicted values for standardised ratios (e.g. the predicted number of cases), or the number of patients/discharges etc. Our centre line, the average value, can be surrounded by ‘control limits,’ a concept from Statistical Process Control. These limits are statistical boundaries to separate natural (‘common-cause’) variation and systematic differences (‘special-cause variation’) <span class="citation">(Mohammed et al. 2001)</span>. This is commonly at organisational level, but could be at any aggregation.</p>
<p>The reason these limits resemble a funnel is due to the effects of size. The expected variation is larger when we are looking at fewer cases. For example, imagine an experiment where we toss an unbiased coin to see the expected value. If we toss that coin twice and both are ‘heads,’ our data is telling us that all coin tosses end up as ‘heads.’ This is not true, and we are making an assumption that we know would be different if we repeated it more times. The margin of error around this is high. So if we performed the same experiment 10, 100 or 1000 times, we would expect it to become 50:50, heads/tails, and the margin of error is proportionally smaller. This is also true of indicators based on counts, like funnel plots. We expect less variation between points as organisations get larger.</p>
</div>
<div id="example" class="section level3">
<h3 class="hasAnchor">
<a href="#example" class="anchor"></a>Example:</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tidyr)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="co"># Make up some data, as if it was from a regression model with observed and predicted (expected) events.</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5">dt &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">observed =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>( <span class="dv">15</span>,<span class="dv">40</span>,<span class="dv">72</span>,<span class="dv">28</span>,<span class="dv">50</span>, <span class="dv">66</span>, <span class="dv">75</span>),</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">                 <span class="dt">expected =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>( <span class="dv">13</span>,<span class="dv">32</span>,<span class="dv">75</span>,<span class="dv">33</span>,<span class="dv">54</span>, <span class="dv">60</span>, <span class="dv">72</span>),</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">                 <span class="dt">unit =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"A"</span>,<span class="st">"B"</span>,<span class="st">"c"</span>,<span class="st">"D"</span>,<span class="st">"E"</span>, <span class="st">"F"</span>, <span class="st">"G"</span>))</a>
<a class="sourceLine" id="cb1-8" data-line-number="8">)</a>
<a class="sourceLine" id="cb1-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="co"># Add a ratio (SR) of observed to expected, our indicator </span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11">dt<span class="op">$</span>SR &lt;-<span class="st"> </span>dt<span class="op">$</span>observed <span class="op">/</span><span class="st"> </span>dt<span class="op">$</span>expected</a>
<a class="sourceLine" id="cb1-12" data-line-number="12"></a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="co"># Scatter plot in ggplot</span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14">a&lt;-<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(dt, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x=</span>expected, <span class="dt">y=</span> SR))<span class="op">+</span></a>
<a class="sourceLine" id="cb1-15" data-line-number="15"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>()</a>
<a class="sourceLine" id="cb1-16" data-line-number="16"></a>
<a class="sourceLine" id="cb1-17" data-line-number="17">a</a></code></pre></div>
<p><img src="funnel_plots_files/figure-html/basicfunnel-1.png" width="672"></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="co"># Now add a central line, in a ration like this, 1 is the average/expected value.</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">a&lt;-<span class="st"> </span>a<span class="op">+</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">yintercept=</span><span class="dv">1</span>))</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">a</a></code></pre></div>
<p><img src="funnel_plots_files/figure-html/basicfunnel-2.png" width="672"></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co"># Add a 95% Poisson limit, by using the density function to get the quantile value for each 'expected'.</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">lkup&lt;-<span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">id=</span><span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="dv">1</span>, <span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(dt<span class="op">$</span>expected), <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">lkup<span class="op">$</span>Upper&lt;-(<span class="kw"><a href="https://rdrr.io/r/stats/Poisson.html">qpois</a></span>(<span class="fl">0.975</span>,<span class="dt">lambda =</span> lkup<span class="op">$</span>id) <span class="op">-</span><span class="st"> </span><span class="fl">0.025</span>) <span class="op">/</span><span class="st"> </span>lkup<span class="op">$</span>id</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">lkup<span class="op">$</span>lower&lt;-(<span class="kw"><a href="https://rdrr.io/r/stats/Poisson.html">qpois</a></span>(<span class="fl">0.025</span>,<span class="dt">lambda =</span> lkup<span class="op">$</span>id) <span class="op">-</span><span class="st"> </span><span class="fl">0.975</span>) <span class="op">/</span><span class="st"> </span>lkup<span class="op">$</span>id</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">lkup&lt;-<span class="kw"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span>(lkup, key, value,<span class="op">-</span>id)</a>
<a class="sourceLine" id="cb3-8" data-line-number="8"></a>
<a class="sourceLine" id="cb3-9" data-line-number="9">a<span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x=</span>id, <span class="dt">y=</span>value, <span class="dt">col=</span>key), <span class="dt">data=</span>lkup)</a></code></pre></div>
<p><img src="funnel_plots_files/figure-html/basicfunnel-3.png" width="672"></p>
<p>You’ll probably notice the ‘jagged’ lines in the plot above. This is because the Poisson distribution is only defined on integers, and most common implementations of Poisson functions make some sort of rounding/guess between points. They are generally poorly defined on low values, but there are other options that I’ll discuss in another future post.</p>
<p><br></p>
</div>
</div>
<div id="expanding-limits" class="section level2">
<h2 class="hasAnchor">
<a href="#expanding-limits" class="anchor"></a>Expanding limits</h2>
<p>The methods described above have been developed into a basic R package to draw these plots using <code>ggplot2</code>. It also allows users to specify whether they want ‘overdispersed’ limits. I will write another post about overdispersion in the coming weeks, but essentially, we have more variation than we would expect from theory alone. To account for this, we can estimate how much greater the variance in our data is, and expand the funnel limits by this amount.</p>
<p>Part of this process involves ‘Winsorisation’ of the distribution <span class="citation">(Spiegelhalter 2005b; Spiegelhalter et al. 2012)</span>, where we set the outer most values to a defined percentile to reduce the effects of outliers. This is commonly set to 10% at each end of the distribution, but there is a variant method for this, used in the NHS’ Summary Hospital Mortality Indicator’, where the distribution is truncated instead of Winsorised <span class="citation">(Clinical Indicators Team 2018)</span>.</p>
<p>I originally wrote this package to present plots for my PhD thesis, focused on predicting NRLS incident reporting ratios after risk-adjustment. The overdispersion was particularly high in this case, and differences between the two methods were noticeable, with the SHMI/truncation method appearing better suited.</p>
<p><br></p>
</div>
<div id="application" class="section level2">
<h2 class="hasAnchor">
<a href="#application" class="anchor"></a>Application</h2>
<p>Here we will apply this to some data by picking up the <code>medpar</code> dataset discussed by Hilbe and available in the <code>COUNT</code> package <span class="citation">(Hilbe 2014)</span>. It is a set of data points from hospitals in Arizona, in 1991, based on US Medicare data. We’ll use the ‘length of stay’ field ’, <code>los</code>, and model it from the other predictors in the data.</p>
<div id="installation" class="section level3">
<h3 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">"https://github.com/chrismainey/FunnelPlotR"</span>)</a></code></pre></div>
</div>
<div id="basic-model-build" class="section level3">
<h3 class="hasAnchor">
<a href="#basic-model-build" class="anchor"></a>Basic model build</h3>
<p>We will first load the data and build a simple predictive model, using a Poisson GLM, with a few of the predictors from the dataset. This post is not focused on modelling techniques, but a Poisson Generalised Linear Model (GLM) is more appropriate for count data than linear regression. The key message, though, is that Poisson models make no adjustment for the variance within the data and are likely to be overdispersed. A more sophisticated approach might use something like a negative binomial or multilevel model (discussed in a later post).</p>
<p>A little reformatting is required before modelling:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(FunnelPlotR)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(COUNT)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(medpar)</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">medpar<span class="op">$</span>provnum&lt;-<span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(medpar<span class="op">$</span>provnum)</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">medpar<span class="op">$</span>los&lt;-<span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(medpar<span class="op">$</span>los)</a>
<a class="sourceLine" id="cb5-8" data-line-number="8"></a>
<a class="sourceLine" id="cb5-9" data-line-number="9">mod&lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(los <span class="op">~</span><span class="st"> </span>hmo <span class="op">+</span><span class="st"> </span>died <span class="op">+</span><span class="st"> </span>age80 <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(type), <span class="dt">family=</span><span class="st">"poisson"</span>, <span class="dt">data=</span>medpar)</a>
<a class="sourceLine" id="cb5-10" data-line-number="10"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(mod)</a>
<a class="sourceLine" id="cb5-11" data-line-number="11"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb5-12" data-line-number="12"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb5-13" data-line-number="13"><span class="co">#&gt; glm(formula = los ~ hmo + died + age80 + factor(type), family = "poisson", </span></a>
<a class="sourceLine" id="cb5-14" data-line-number="14"><span class="co">#&gt;     data = medpar)</span></a>
<a class="sourceLine" id="cb5-15" data-line-number="15"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb5-16" data-line-number="16"><span class="co">#&gt; Deviance Residuals: </span></a>
<a class="sourceLine" id="cb5-17" data-line-number="17"><span class="co">#&gt;     Min       1Q   Median       3Q      Max  </span></a>
<a class="sourceLine" id="cb5-18" data-line-number="18"><span class="co">#&gt; -5.7309  -1.9554  -0.5529   0.9717  14.5487  </span></a>
<a class="sourceLine" id="cb5-19" data-line-number="19"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb5-20" data-line-number="20"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb5-21" data-line-number="21"><span class="co">#&gt;               Estimate Std. Error z value Pr(&gt;|z|)    </span></a>
<a class="sourceLine" id="cb5-22" data-line-number="22"><span class="co">#&gt; (Intercept)    2.26875    0.01246 182.011  &lt; 2e-16 ***</span></a>
<a class="sourceLine" id="cb5-23" data-line-number="23"><span class="co">#&gt; hmo           -0.07637    0.02393  -3.192  0.00142 ** </span></a>
<a class="sourceLine" id="cb5-24" data-line-number="24"><span class="co">#&gt; died          -0.24574    0.01826 -13.458  &lt; 2e-16 ***</span></a>
<a class="sourceLine" id="cb5-25" data-line-number="25"><span class="co">#&gt; age80         -0.02141    0.02050  -1.045  0.29617    </span></a>
<a class="sourceLine" id="cb5-26" data-line-number="26"><span class="co">#&gt; factor(type)2  0.24921    0.02099  11.871  &lt; 2e-16 ***</span></a>
<a class="sourceLine" id="cb5-27" data-line-number="27"><span class="co">#&gt; factor(type)3  0.74869    0.02627  28.496  &lt; 2e-16 ***</span></a>
<a class="sourceLine" id="cb5-28" data-line-number="28"><span class="co">#&gt; ---</span></a>
<a class="sourceLine" id="cb5-29" data-line-number="29"><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></a>
<a class="sourceLine" id="cb5-30" data-line-number="30"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb5-31" data-line-number="31"><span class="co">#&gt; (Dispersion parameter for poisson family taken to be 1)</span></a>
<a class="sourceLine" id="cb5-32" data-line-number="32"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb5-33" data-line-number="33"><span class="co">#&gt;     Null deviance: 8901.1  on 1494  degrees of freedom</span></a>
<a class="sourceLine" id="cb5-34" data-line-number="34"><span class="co">#&gt; Residual deviance: 7977.7  on 1489  degrees of freedom</span></a>
<a class="sourceLine" id="cb5-35" data-line-number="35"><span class="co">#&gt; AIC: 13705</span></a>
<a class="sourceLine" id="cb5-36" data-line-number="36"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb5-37" data-line-number="37"><span class="co">#&gt; Number of Fisher Scoring iterations: 5</span></a></code></pre></div>
<p>Now we have a regression that we can use to get a predicted <code>los</code> that we will compare to observed <code>los</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">medpar<span class="op">$</span>prds&lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(mod, <span class="dt">type=</span><span class="st">"response"</span>)</a></code></pre></div>
<p><br></p>
</div>
<div id="build-plot" class="section level3">
<h3 class="hasAnchor">
<a href="#build-plot" class="anchor"></a>Build plot</h3>
<p>Now we can build a funnel plot object with standard Poisson limits, and outliers labelled. The function returns a list of the plotted data, the plotted control limit range, and the <code>ggplot</code> object, hence <code>object[3]</code> to call it.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="kw"><a href="../reference/funnel_plot.html">funnel_plot</a></span>(<span class="dt">numerator=</span>medpar<span class="op">$</span>los, <span class="dt">denominator=</span>medpar<span class="op">$</span>prds, <span class="dt">group =</span> medpar<span class="op">$</span>provnum, </a>
<a class="sourceLine" id="cb7-3" data-line-number="3">            <span class="dt">title =</span> <span class="st">'Length of Stay Funnel plot for `medpar` data'</span>, <span class="dt">Poisson_limits =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">            <span class="dt">OD_adjust =</span> <span class="ot">FALSE</span>,<span class="dt">label_outliers =</span> <span class="dv">99</span>, <span class="dt">return_elements =</span> <span class="st">"plot"</span>)</a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="co">#&gt; $plot</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="co">#&gt; Warning: Removed 1 rows containing missing values (geom_point).</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="co">#&gt; Warning: Removed 1 rows containing missing values (geom_label_repel).</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8"></a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="co">#&gt; Warning: Removed 1 rows containing missing values (geom_label_repel).</span></a></code></pre></div>
<p><img src="funnel_plots_files/figure-html/funnel1-1.png" width="672" style="display: block; margin: auto;"></p>
<p><br></p>
</div>
<div id="overdispersion" class="section level3">
<h3 class="hasAnchor">
<a href="#overdispersion" class="anchor"></a>Overdispersion</h3>
<p>That looks like too many outliers! There is more variation in our data than we would expect, and this is referred to as: <strong>overdispersion</strong>.</p>
<p><br> So lets check for it: <br> The following ratio should be 1 if our data are conforming to Poisson distribution assumption (conditional mean = variance). If it is greater than 1, we have overdispersion:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"></a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(mod<span class="op">$</span>weights <span class="op">*</span><span class="st"> </span>mod<span class="op">$</span>residuals<span class="op">^</span><span class="dv">2</span>)<span class="op">/</span>mod<span class="op">$</span>df.residual</a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="co">#&gt; [1] 6.240519</span></a></code></pre></div>
<p>This suggests the variance is 6.24 times the condition mean, and definitely overdispersed. This is a huge topic, but applying overdispersed limits using either SHMI or Spieglehalter methods adjust for this by inflating the limits:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw"><a href="../reference/funnel_plot.html">funnel_plot</a></span>(<span class="dt">numerator=</span>medpar<span class="op">$</span>los, <span class="dt">denominator=</span>medpar<span class="op">$</span>prds, <span class="dt">group =</span> medpar<span class="op">$</span>provnum, </a>
<a class="sourceLine" id="cb9-2" data-line-number="2">            <span class="dt">title =</span> <span class="st">'Length of Stay Funnel plot for `medpar` data'</span>, <span class="dt">Poisson_limits =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">            <span class="dt">OD_adjust =</span> <span class="ot">TRUE</span>, <span class="dt">method =</span> <span class="st">"SHMI"</span>,<span class="dt">label_outliers =</span> <span class="dv">99</span>, <span class="dt">return_elements =</span> <span class="st">"plot"</span>)</a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="co">#&gt; $plot</span></a></code></pre></div>
<p><img src="funnel_plots_files/figure-html/funnel2-1.png" width="672" style="display: block; margin: auto;"></p>
<p><br><br> Given these adjustments, we now only have nine organisations showing special-cause variation. To interpret this plot properly, we would first investigate these outlying organisations before making any changes to the system/indicator. We should check for possible data quality issues, such as errors, missing model predictors, environmental factors (e.g. one organisation changing computer systems and data standards etc. during the monitoring period), but once these are examined we might suspect issues with care at the hospitals in question. They can then be investigated by local audit and casenote review.</p>
<p>These methods can be used for any similar indicators, e.g. standardised mortality ratios, readmissions etc.</p>
<p><br></p>
</div>
</div>
<div id="summary" class="section level2">
<h2 class="hasAnchor">
<a href="#summary" class="anchor"></a>Summary</h2>
<p>Funnel plots are useful ways to visualise indicators such as mortality, readmission and length of stay data at hospitals, that presents both the indicator value but also a measure of the size/variance at organisations. They allow limits to be drawn between what we might expect by chance, and what we might consider to be a signal for investigation. Organisations outside the funnel limits should be examined, first for data quality issues and then for issues with process and clinical care. Overdispersion means that these limits are often too strict, but they can be inflated to adjusted for this.</p>
<p><br></p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-clinicalindicatorsteamnhsdigitalSummaryHospitallevelMortality2018">
<p>Clinical Indicators Team, NHS Digital. 2018. “Summary Hospital-Level Mortality Indicator (SHMI) - Indicator Specification.” NHS Digital.</p>
</div>
<div id="ref-goldsteinLeagueTablesTheir1996">
<p>Goldstein, Harvey, and David J. Spiegelhalter. 1996. “League Tables and Their Limitations: Statistical Issues in Comparisons of Institutional Performance.” <em>Journal of the Royal Statistical Society: Series A (Statistics in Society)</em> 159 (3): 385–409. <a href="https://doi.org/10/chf9kj" class="uri">https://doi.org/10/chf9kj</a>.</p>
</div>
<div id="ref-hilbeModelingCountData2014">
<p>Hilbe, Joseph M. 2014. <em>Modeling Count Data</em>. Cambridge: Cambridge University Press. <a href="https://doi.org/10.1017/CBO9781139236065" class="uri">https://doi.org/10.1017/CBO9781139236065</a>.</p>
</div>
<div id="ref-lilfordUseMisuseProcess2004">
<p>Lilford, R., M. A. Mohammed, D. Spiegelhalter, and R. Thomson. 2004. “Use and Misuse of Process and Outcome Data in Managing Performance of Acute Medical Care: Avoiding Institutional Stigma.” <em>Lancet</em> 363 (9415): 1147–54. <a href="https://doi.org/10.1016/s0140-6736(04)15901-1" class="uri">https://doi.org/10.1016/s0140-6736(04)15901-1</a>.</p>
</div>
<div id="ref-mohammedBristolShipmanClinical2001">
<p>Mohammed, Mohammed A, KK Cheng, Andrew Rouse, and Tom Marshall. 2001. “Bristol, Shipman, and Clinical Governance: Shewhart’s Forgotten Lessons.” <em>The Lancet</em> 357 (9254): 463–67. <a href="https://doi.org/10/cqjskf" class="uri">https://doi.org/10/cqjskf</a>.</p>
</div>
<div id="ref-spiegelhalterFunnelPlotsComparing2005">
<p>Spiegelhalter, David J. 2005a. “Funnel Plots for Comparing Institutional Performance.” <em>Stat Med</em> 24 (8): 1185–1202. <a href="https://doi.org/10.1002/sim.1970" class="uri">https://doi.org/10.1002/sim.1970</a>.</p>
</div>
<div id="ref-spiegelhalterHandlingOverdispersionPerformance2005">
<p>———. 2005b. “Handling over-Dispersion of Performance Indicators.” <em>Quality and Safety in Health Care</em> 14 (5): 347–51. <a href="https://doi.org/10.1136/qshc.2005.013755" class="uri">https://doi.org/10.1136/qshc.2005.013755</a>.</p>
</div>
<div id="ref-spiegelhalterStatisticalMethodsHealthcare2012">
<p>Spiegelhalter, David J., Christopher Sherlaw-Johnson, Martin Bardsley, Ian Blunt, Christopher Wood, and Olivia Grigg. 2012. “Statistical Methods for Healthcare Regulation: Rating, Screening and Surveillance.” <em>Journal of the Royal Statistical Society: Series A (Statistics in Society)</em> 175 (1): 1–47. <a href="https://doi.org/10.1111/j.1467-985X.2011.01010.x" class="uri">https://doi.org/10.1111/j.1467-985X.2011.01010.x</a>.</p>
</div>
<div id="ref-wickhamGgplot2ElegantGraphics2009">
<p>Wickham, Hadley. 2009. <em>Ggplot2: Elegant Graphics for Data Analysis</em>. New York: Springer-Verlag.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#funnel-plots">Funnel plots</a></li>
      <li><a href="#why-do-we-use-them">Why do we use them?</a></li>
      <li><a href="#expanding-limits">Expanding limits</a></li>
      <li><a href="#application">Application</a></li>
      <li><a href="#summary">Summary</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="http://www.mainard.co.uk">Chris Mainey</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
