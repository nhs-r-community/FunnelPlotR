---
output:
  github_document:
    html_preview: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  dev.args = list(png = list(type = "cairo"))
)
```
 


  

# Funnel plots for comparing institutional performance <img src="man/figures/logo.png" width="160px" align="right" />

<!-- badges: start -->
[![Travis build status](https://travis-ci.org/chrismainey/FunnelPlotR.svg?branch=master)](https://travis-ci.org/chrismainey/FunnelPlotR)
[![Project Status: Active â€“ The project has reached a stable, usable state and is being actively developed.](https://www.repostatus.org/badges/latest/active.svg)](https://www.repostatus.org/#active)
[![CRAN version](http://www.r-pkg.org/badges/version/FunnelPlotR)](https://cran.r-project.org/package=FunnelPlotR)
![](http://cranlogs.r-pkg.org/badges/grand-total/FunnelPlotR)

[![codecov](https://codecov.io/gh/chrismainey/FunnelPlotR/branch/master/graph/badge.svg)](https://codecov.io/gh/chrismainey/FunnelPlotR) 
<br><br>
<!-- badges: end -->
  
## Funnel Plots
__This package is the newer version of the older `CMFunnels` package. Development work will focus on this package from now on.__

This is an implementation of the funnel plot processes, and overdispersion methods described in:<br>
[Statistical methods for healthcare regulation: rating, screening and surveillance. Spiegelhalter et al (2012)](https://rss.onlinelibrary.wiley.com/doi/full/10.1111/j.1467-985X.2011.01010.x)<br>
[Funnel plots for comparing institutional performance. Spiegelhalter (2005)](https://onlinelibrary.wiley.com/doi/10.1002/sim.1970)<br>
[Handling over-dispersion of performance indicators. Spiegelhalter (2005)](https://qualitysafety.bmj.com/content/14/5/347)<br>
    
It draws funnel plots using `ggplot2` and allows users to specify whether they want t adjust the funnel plot limits for 'overdispersion.'  This adjustment makes the assumption that we are dealing with clusters of values (means) at institutions that are themselves arranged around a global mean.  We then have 'within' institution variation and 'between institution' variation.   The process assessed the expected variance in our data, and where it is greater than that expected by the Poisson distribution, uses the difference as a scaling factor.  It is then used in an additive fashion, after 'robustifying' the data by either Winsorised or truncated (with a default 10% at each end of the distribution.)

Methods are based on those presented in Spiegelhalter's papers and the Care Quality Commission's Intelligent Monitoring methodology documents.  There is a variant method for standardised ratios, used in the NHS' Summary Hospital Mortality Indicator'<br>
[Summary Hospital-level Mortality Indicator, NHS Digital, SHMI specification](https://digital.nhs.uk/data-and-information/publications/ci-hub/summary-hospital-level-mortality-indicator-shmi) <br>

This uses a log-transformation and truncation of the distribution for calculating overdispersion, whereas Spiegelhalter's methods use a square-root and Winsorisation.


This package was originally developed for use in the author's PhD project, but published on github in case it's of use for others.

Contributions are welcome.  Please note that the 'FunnelPlotR' project is released with a
[Contributor Code of Conduct](https://chrismainey.github.io/FunnelPlotR/CODE_OF_CONDUCT.html).
By contributing to this project, you agree to abide by its terms.

More information available at https://chrismainey.github.io/FunnelPlotR/ 


## Installation ##

You can install from CRAN, or use the development version on GitHub:
```{r install, eval=FALSE}
install.packages("FunnelPlotR")
# or
remotes::install_github("https://github.com/chrismainey/FunnelPlotR")
```


## Summary of Use

We will load the `medpar` dataset from Hilbe's `COUNT` package.  This is based on 1991 Medicare files for the state of Arizona _(Hilbe, Joseph M (2014), Modeling Count Data, Cambridge University Press)_.
We will first load the data and build a simple predictive model using a Poisson GLM.


```{r data, warning=FALSE, message=FALSE}
library(FunnelPlotR)
library(COUNT)
library(ggplot2)

# lets use the 'medpar' dataset from the 'COUNT' package. Little reformatting needed
data(medpar)
medpar$provnum<-factor(medpar$provnum)
medpar$los<-as.numeric(medpar$los)

mod<- glm(los ~ hmo + died + age80 + factor(type), family="poisson", data=medpar)
summary(mod)

```

Now we have a regression that we can use to get a predicted `los` that we will compare to observed `los`:

```{r, prediction}
medpar$prds<- predict(mod, type="response")

```
<br><br>
We can build a funnel plot object with standard Poisson limits, and outliers labelled.

```{r fig.align='center', fig.retina=5, warning=FALSE, collapse=TRUE, funnel1, message=FALSE, eval=TRUE}
a<-funnel_plot(numerator=medpar$los, denominator=medpar$prds, group = medpar$provnum, 
            title = 'Length of Stay Funnel plot for `medpar` data', data_type="SR",
            Poisson_limits = TRUE, OD_adjust = FALSE, label_outliers = 99, return_elements = "plot" )
a
```


<br><br>

That looks like too many outliers!  There is more variation in our data than we would expect, and this is referred to as: __overdispersion__.
So lets check for it: <br>
The following ratio should be 1 if our data are conforming to Poisson distribution assumption (conditional mean = variance).  If it is greater than 1, we have overdispersion:

```{r, ODcheck, message=FALSE}

sum(mod$weights * mod$residuals^2)/mod$df.residual

```

This suggest the variance is 6.24 times the condition mean, and definitely overdispersed.
This is a huge topic, but applying overdispersed limits using either SHMI or Spiegelhalter methods adjust for this by inflating the limits:

```{r, funnel2, message=FALSE, fig.align='center', fig.retina=5, collapse=TRUE, warning=FALSE, eval=TRUE}
b<-funnel_plot(numerator=medpar$los, denominator=medpar$prds, group = medpar$provnum, data_type = "SR",
            title = 'Length of Stay Funnel plot for `medpar` data', Poisson_limits = FALSE,
            OD_adjust = TRUE, sr_method = "SHMI",label_outliers = 99, return_elements = "plot")

b
```

<br><br>
These methods can be used for any similar indicators, e.g. standardised mortality ratios, readmissions etc.

Please read the package documentation for more info, at: https://chrismainey.github.io/FunnelPlotR/

Funnel Plot HEX sticker/logo by Paul Chipperfield, check him out at: https://themightychip.com/